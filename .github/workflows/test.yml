# ============================================================================
# WHAT IS THIS FILE?
# ============================================================================
# This is a GitHub Actions "workflow" file. Think of it as a recipe that tells
# GitHub: "When someone pushes code, automatically run these tests for me."
#
# WHERE DOES IT RUN?
# GitHub provides FREE virtual computers (called "runners") in the cloud.
# When you push code, GitHub spins up a fresh computer, runs your tests,
# and shows you the results - all automatically!
#
# NO SETUP NEEDED ON YOUR MACHINE - everything runs on GitHub's servers.
# ============================================================================

name: Run Automation Tests

# ============================================================================
# WHEN SHOULD THIS RUN?
# ============================================================================
on:
  # Run when code is pushed to main or master branch
  push:
    branches: [ main, master ]
  
  # Run when someone creates a Pull Request to main or master
  pull_request:
    branches: [ main, master ]
  
  # Allow manual trigger from GitHub website (Actions tab → Run workflow button)
  workflow_dispatch:

# Required permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write
  checks: write

# ============================================================================
# WHAT ARE THE STEPS?
# ============================================================================
jobs:
  test:
    # Use Ubuntu Linux (free GitHub runner)
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Download your code to the runner
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Install Java 17 (needed to run your tests)
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven  # Cache dependencies to speed up future runs
      
      # Step 3: Install Chrome browser (for Selenium tests)
      - name: Set up Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      # Step 4: Run the tests in headless mode (no display needed)
      - name: Run Web Tests
        run: mvn test -Dheadless=true -Dtest=Tests.web.* --fail-at-end
        continue-on-error: true  # Continue to generate report even if tests fail
      
      # Step 5: Generate Test Summary (shows DIRECTLY in GitHub Actions!)
      - name: Test Summary
        if: always()
        uses: test-summary/action@v2
        with:
          paths: target/surefire-reports/*.xml
      
      # Step 6: Publish Test Results (shows pass/fail details in GitHub)
      - name: Publish Test Results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Test Results
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: false
      
      # Step 7: Generate Allure report
      - name: Generate Allure Report
        if: always()
        run: mvn allure:report
      
      # Step 8: Upload Allure Results (for history)
      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: target/allure-results
          retention-days: 30
      
      # Step 9: Upload the HTML report
      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: target/site/allure-maven-plugin
          retention-days: 30
      
      # Step 10: Deploy Allure Report to GitHub Pages (viewable online!)
      - name: Setup Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: actions/configure-pages@v4
      
      - name: Upload to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: target/site/allure-maven-plugin
      
      - name: Deploy to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        id: deployment
        uses: actions/deploy-pages@v4

# ============================================================================
# HOW TO SEE RESULTS?
# ============================================================================
# 
# OPTION 1: Quick Summary (in GitHub Actions)
# -------------------------------------------
# 1. Go to your GitHub repository
# 2. Click "Actions" tab
# 3. Click on the workflow run
# 4. Scroll down - you'll see a TEST SUMMARY with pass/fail counts!
# 5. Click "Test Results" on the left sidebar for detailed view
#
# OPTION 2: Full Allure Report (online - GitHub Pages)
# ----------------------------------------------------
# After enabling GitHub Pages (one-time setup):
# 1. Go to: https://honda1994.github.io/AutomationFramework/
# 2. The full interactive Allure report is there!
#
# FIRST TIME SETUP FOR GITHUB PAGES:
# ----------------------------------
# 1. Go to your repo → Settings → Pages
# 2. Under "Build and deployment", set Source to "GitHub Actions"
# 3. Save - that's it! The next run will deploy the report.
#
# ============================================================================
